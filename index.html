<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³ÛŒØ³ØªÙ… Ø¬Ø§Ù…Ø¹ Ø²Ù…Ø§Ù†Ø³Ù†Ø¬ÛŒ</title>
  <link rel="manifest" href="manifest.json">
  <style>
    :root { --primary: #4285f4; --secondary: #fbbc04; --bg: #f5f5f5; --card: #fff; }
    body { font-family: Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 0; height: 100vh; display: flex; justify-content: center; }
    .app-container { width: 100%; max-width: 600px; background: var(--card); height: 100%; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    
    .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; box-sizing: border-box; transition: transform 0.3s ease-in-out; background: white; overflow-y: auto; display: none; }
    .view.active { display: block; transform: translateX(0); }
    
    .home-card { text-align: center; margin-top: 50px; }
    .menu-btn { width: 100%; padding: 25px; margin: 15px 0; border: none; border-radius: 15px; font-size: 1.2rem; cursor: pointer; color: white; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-ws { background: linear-gradient(135deg, #4285f4, #2b6ad6); }
    .btn-con { background: linear-gradient(135deg, #fbbc04, #e5a500); color: #333; }
    
    .page-header { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .back-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0 10px; }
    
    .form-group { margin-bottom: 10px; }
    select, button, input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; margin-top: 5px; }
    .timer-box { background: #e8f0fe; padding: 15px; text-align: center; border-radius: 10px; margin: 15px 0; border: 2px solid var(--primary); }
    .timer-display { font-size: 3rem; font-family: monospace; font-weight: bold; color: var(--primary); }
    
    .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
    .btn-action { color: white; border: none; font-weight: bold; }
    .bg-green { background: #34a853; } .bg-red { background: #ea4335; } .bg-blue { background: #4285f4; } .bg-gray { background: #757575; }

    .status-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: #333; color: white; text-align: center; padding: 8px; font-size: 0.8rem; }
    
    /* Ù…ÙˆØ¯Ø§Ù„ Ù„Ø§ÛŒØ³Ù†Ø³ */
    #license-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
  </style>
</head>
<body>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„Ø§ÛŒØ³Ù†Ø³ -->
<div id="license-modal" style="display:none;">
  <h2>ğŸ”‘ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h2>
  <p>Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù„Ø§ÛŒØ³Ù†Ø³ Ø´Ø±Ú©Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
  <input type="text" id="input-license" placeholder="Ù…Ø«Ø§Ù„: TEST_CLIENT" style="max-width:300px; text-align:center;">
  <button class="btn-action bg-blue" onclick="saveLicenseManual()" style="max-width:300px; margin-top:15px;">ØªØ§ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
</div>

<div class="app-container" id="main-app" style="display:none;">

  <!-- ================= ØµÙØ­Ù‡ Û±: Ø®Ø§Ù†Ù‡ ================= -->
  <div id="view-home" class="view active">
    <div class="home-card">
      <h1 style="color:#4285f4">â±ï¸ Ø³ÛŒØ³ØªÙ… Ø²Ù…Ø§Ù†Ø³Ù†Ø¬ÛŒ</h1>
      <p id="license-display" style="color:#666; font-size:0.8rem; margin-bottom:40px;">...</p>
      
      <button class="menu-btn btn-ws" onclick="navigate('workstation')">ğŸ­ Ø²Ù…Ø§Ù†Ø³Ù†Ø¬ÛŒ Ú©Ø§Ø±Ú¯Ø§Ù‡ÛŒ</button>
      <button class="menu-btn btn-con" onclick="navigate('continuous')">ğŸ”„ Ø²Ù…Ø§Ù†Ø³Ù†Ø¬ÛŒ Ù¾ÛŒÙˆØ³ØªÙ‡</button>

      <div style="margin-top: 30px; font-size: 0.8rem; color: #999;">
         ØµÙ Ø¢ÙÙ„Ø§ÛŒÙ†: <span id="queueCount">0</span> Ø±Ú©ÙˆØ±Ø¯
         <br><a href="#" onclick="clearLicense()" style="color:#ea4335; text-decoration:none;">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</a>
         <br><button onclick="forceSync()" style="font-size:0.7rem; margin-top:10px; width:auto; padding:5px; background:#fbbc04; color:#333;">ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>

  <!-- ================= ØµÙØ­Ù‡ Û²: Ú©Ø§Ø±Ú¯Ø§Ù‡ÛŒ ================= -->
  <div id="view-workstation" class="view">
    <div class="page-header">
      <button class="back-btn" onclick="navigate('home')">ğŸ </button>
      <h2>ğŸ­ Ú©Ø§Ø±Ú¯Ø§Ù‡ÛŒ</h2>
    </div>
    <select class="sel-shift"><option>Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>
    <select class="sel-operator"><option>Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>
    <select class="sel-product"><option>Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>
    <select class="sel-station"><option>Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>

    <div class="timer-box">
      <div id="ws-display" class="timer-display">00:00.00</div>
    </div>

    <div class="controls">
      <button id="ws-btnRecord" class="btn-action bg-blue" onclick="ws_recordLap()" disabled>ğŸš© Ø«Ø¨Øª Ø¯ÙˆØ±</button>
      <button id="ws-btnStart" class="btn-action bg-green" onclick="ws_startTimer()">â–¶ Ø´Ø±ÙˆØ¹</button>
      <button id="ws-btnSave" class="btn-action bg-red" onclick="ws_finish()" disabled>ğŸ’¾ Ù¾Ø§ÛŒØ§Ù†</button>
    </div>
    <div id="ws-laps" style="margin-top:15px; max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px;"></div>
  </div>

  <!-- ================= ØµÙØ­Ù‡ Û³: Ù¾ÛŒÙˆØ³ØªÙ‡ ================= -->
  <div id="view-continuous" class="view">
    <div class="page-header">
      <button class="back-btn" onclick="navigate('home')">ğŸ </button>
      <h2>ğŸ”„ Ù¾ÛŒÙˆØ³ØªÙ‡</h2>
    </div>
    <select class="sel-shift"><option>Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>
    <select class="sel-operator"><option>Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>
    <select class="sel-product"><option>Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>
    <select class="sel-station"><option>Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option></select>

    <div class="timer-box" style="border-color: #fbbc04; background: #fff8e1;">
      <div id="con-display" class="timer-display" style="color: #e5a500;">00:00.00</div>
    </div>

    <div class="controls">
      <button id="con-btnStop" class="btn-action bg-red" onclick="con_stopTimer()" disabled>â¸ ØªÙˆÙ‚Ù</button>
      <button id="con-btnStart" class="btn-action bg-green" onclick="con_startTimer()">â–¶ Ø´Ø±ÙˆØ¹</button>
      <button class="btn-action bg-gray" onclick="con_reset()">â¹ Ø±ÛŒØ³Øª</button>
    </div>

    <div style="background:#eee; padding:15px; border-radius:10px; margin-top:20px;">
      <label>ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÙ„ÛŒØ¯:</label>
      <input type="number" id="con-count" placeholder="Ù…Ø«Ù„Ø§ 100" style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd;">
      <button class="btn-action bg-blue" style="margin-top:10px;" onclick="con_save()">ğŸ’¾ Ø«Ø¨Øª</button>
    </div>
  </div>
  
  <div class="status-bar" id="appStatus">ğŸŸ¢ Ù…ØªØµÙ„</div>
</div>

<script>
// --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ (Ù„ÛŒÙ†Ú© ÙˆØ¨ Ø§Ù¾ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯) ---
const API_URL = "https://script.google.com/macros/s/AKfycbwGTi5x558NO2dq_ylKfGKnfntdRW03eiBzAfpGfgrqZrFMLkWfnqEhPSE2mT8pCWNHdw/exec"; 

// --- Ù…Ø¯ÛŒØ±ÛŒØª Ù„Ø§ÛŒØ³Ù†Ø³ ---
let CURRENT_LICENSE = localStorage.getItem('app_license');

function checkLicenseStart() {
  const urlParams = new URLSearchParams(window.location.search);
  const urlLicense = urlParams.get('license');

  if (urlLicense) {
    CURRENT_LICENSE = urlLicense;
    localStorage.setItem('app_license', urlLicense);
    showApp();
  } else if (CURRENT_LICENSE) {
    showApp();
  } else {
    document.getElementById('license-modal').style.display = 'flex';
  }
}

function saveLicenseManual() {
  const val = document.getElementById('input-license').value.trim();
  if (val) {
    CURRENT_LICENSE = val;
    localStorage.setItem('app_license', val);
    window.location.search = `?license=${val}`;
  } else {
    alert("Ù„Ø·ÙØ§Ù‹ Ù„Ø§ÛŒØ³Ù†Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
  }
}

function clearLicense() {
  if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) {
    localStorage.removeItem('app_license');
    localStorage.removeItem('app_config');
    window.location.href = window.location.pathname;
  }
}

function showApp() {
  document.getElementById('license-modal').style.display = 'none';
  document.getElementById('main-app').style.display = 'flex';
  document.getElementById('license-display').innerText = `Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ: ${CURRENT_LICENSE}`;
  loadConfig();
  updateQueueCount();
  // ØªÙ„Ø§Ø´ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø³ÛŒÙ†Ú© Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ø¯Ø± ØµÙ
  setTimeout(attemptSync, 2000);
}

function navigate(pageId) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.getElementById(`view-${pageId}`).classList.add('active');
  if(pageId === 'home') updateQueueCount();
}

window.onload = function() {
  checkLicenseStart();
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
};

// --- Ù…Ù†Ø·Ù‚ Ø²Ù…Ø§Ù†Ø³Ù†Ø¬ÛŒ Ú©Ø§Ø±Ú¯Ø§Ù‡ÛŒ ---
let ws_timer, ws_start = 0, ws_elapsed = 0, ws_laps = [];
function ws_startTimer() {
  ws_start = Date.now() - ws_elapsed;
  ws_timer = setInterval(() => { ws_elapsed = Date.now() - ws_start; updateDisplay('ws-display', ws_elapsed); }, 10);
  document.getElementById('ws-btnStart').disabled = true;
  document.getElementById('ws-btnRecord').disabled = false;
  document.getElementById('ws-btnSave').disabled = false;
}
function ws_recordLap() {
  const sec = parseFloat((ws_elapsed / 1000).toFixed(2));
  ws_laps.push(sec);
  const div = document.createElement('div'); div.innerText = `#${ws_laps.length}: ${sec}s`;
  document.getElementById('ws-laps').prepend(div);
  ws_elapsed = 0; ws_start = Date.now(); updateDisplay('ws-display', 0);
}
function ws_finish() {
  clearInterval(ws_timer);
  const data = getFormData('view-workstation');
  if(!data) return;
  
  // Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡ Ø¯Ø± ØµÙ
  saveOffline({ id: Date.now(), type: 'workstation', data: { ...data, times: ws_laps }, timestamp: new Date().toISOString() });
  
  ws_laps = []; ws_elapsed = 0; updateDisplay('ws-display', 0);
  document.getElementById('ws-laps').innerHTML = ''; document.getElementById('ws-btnStart').disabled = false;
  alert("âœ… Ø«Ø¨Øª Ø´Ø¯"); navigate('home');
}

// --- Ù…Ù†Ø·Ù‚ Ø²Ù…Ø§Ù†Ø³Ù†Ø¬ÛŒ Ù¾ÛŒÙˆØ³ØªÙ‡ ---
let con_timer, con_start = 0, con_elapsed = 0, con_running = false;
function con_startTimer() {
  if(con_running) return;
  con_start = Date.now() - con_elapsed;
  con_timer = setInterval(() => { con_elapsed = Date.now() - con_start; updateDisplay('con-display', con_elapsed); }, 10);
  con_running = true; document.getElementById('con-btnStart').disabled = true; document.getElementById('con-btnStop').disabled = false;
}
function con_stopTimer() { clearInterval(con_timer); con_running = false; document.getElementById('con-btnStart').disabled = false; document.getElementById('con-btnStop').disabled = true; }
function con_reset() { con_stopTimer(); con_elapsed = 0; updateDisplay('con-display', 0); }
function con_save() {
  const count = document.getElementById('con-count').value;
  if(!count) return alert("ØªØ¹Ø¯Ø§Ø¯ØŸ");
  const data = getFormData('view-continuous');
  if(!data) return;
  const totalTimeSec = parseFloat((con_elapsed / 1000).toFixed(2));
  
  // Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡ Ø¯Ø± ØµÙ
  saveOffline({ id: Date.now(), type: 'continuous', data: { ...data, totalTime: totalTimeSec, count: count, rate: (totalTimeSec / count).toFixed(2) }, timestamp: new Date().toISOString() });
  
  con_reset(); document.getElementById('con-count').value = ''; alert("âœ… Ø«Ø¨Øª Ø´Ø¯"); navigate('home');
}

// --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
function updateDisplay(id, ms) {
  const s = Math.floor(ms / 1000); const m = Math.floor(s / 60); const msShow = Math.floor((ms % 1000) / 10);
  document.getElementById(id).innerText = `${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}.${String(msShow).padStart(2,'0')}`;
}
function getFormData(viewId) {
  const parent = document.getElementById(viewId);
  const shift = parent.querySelector('.sel-shift').value;
  const operator = parent.querySelector('.sel-operator').value;
  if(shift.includes('...') || operator.includes('...')) { alert("ØªÚ©Ù…ÛŒÙ„ Ú©Ù†ÛŒØ¯"); return null; }
  return { shift, operator, product: parent.querySelector('.sel-product').value, station: parent.querySelector('.sel-station').value };
}

// --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯ÛŒØªØ§ Ùˆ ØµÙ ---
function saveOffline(record) {
  let queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
  queue.push(record);
  localStorage.setItem('offline_queue', JSON.stringify(queue));
  updateQueueCount(); attemptSync();
}
function updateQueueCount() { document.getElementById('queueCount').innerText = JSON.parse(localStorage.getItem('offline_queue') || '[]').length; }

function forceSync() {
  document.getElementById('appStatus').innerText = "â³ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø³ØªÛŒ...";
  attemptSync();
}

async function attemptSync() {
  if(!navigator.onLine) { document.getElementById('appStatus').innerText = "ğŸ”´ Ø¢ÙÙ„Ø§ÛŒÙ†"; return; }
  let queue = JSON.parse(localStorage.getItem('offline_queue') || '[]');
  if(queue.length === 0) { document.getElementById('appStatus').innerText = "ğŸŸ¢ Ø¢Ù†Ù„Ø§ÛŒÙ†"; return; }
  
  document.getElementById('appStatus').innerText = "ğŸ”„ Ø§Ø±Ø³Ø§Ù„...";
  
  // ØªØ±ÙÙ†Ø¯ Ù…Ù‡Ù…: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² text/plain Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² preflight request (CORS)
  try {
    const res = await fetch(API_URL, { 
      method: "POST", 
      body: JSON.stringify({ license: CURRENT_LICENSE, payload: queue }),
      headers: {
        "Content-Type": "text/plain;charset=utf-8" 
      }
    });
    const json = await res.json();
    if(json.status === 'success') {
       localStorage.setItem('offline_queue', '[]'); 
       updateQueueCount(); 
       document.getElementById('appStatus').innerText = "âœ… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯";
       console.log("Sync Success:", json);
    } else { 
       document.getElementById('appStatus').innerText = "âš ï¸ Ø®Ø·Ø§: " + json.message;
       console.error("Sync Error:", json);
    }
  } catch(e) { 
    document.getElementById('appStatus').innerText = "âš ï¸ Ø®Ø·Ø§ Ø´Ø¨Ú©Ù‡ (Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ù…Ù† Ù‡Ø³ØªÙ†Ø¯)"; 
    console.error("Fetch Error:", e);
  }
}

async function loadConfig() {
  // Ø§ÙˆÙ„ Ø§Ø² Ú©Ø´ Ù„ÙˆÚ©Ø§Ù„ Ø¨Ø®ÙˆØ§Ù† ØªØ§ ÙØ±Ù… Ø®Ø§Ù„ÛŒ Ù†Ø¨Ø§Ø´Ø¯
  const cached = localStorage.getItem('app_config');
  if(cached) {
    console.log("Loading config from local storage...");
    populateAllSelects(JSON.parse(cached));
  }

  // Ø³Ù¾Ø³ Ø§Ø² Ø³Ø±ÙˆØ± ØªÙ„Ø§Ø´ Ú©Ù† Ø¨Ú¯ÛŒØ±ÛŒ
  if(navigator.onLine) {
    try {
      console.log("Fetching config from server...");
      const res = await fetch(`${API_URL}?license=${CURRENT_LICENSE}`);
      const json = await res.json();
      
      if(json.status === 'success') {
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù„ÙˆÚ©Ø§Ù„ Ø§Ø³ØªÙˆØ±ÛŒØ¬
        localStorage.setItem('app_config', JSON.stringify(json.data));
        populateAllSelects(json.data);
        console.log("Config updated from server.");
      } else {
        console.error("Server error:", json.message);
      }
    } catch(e) {
      console.error("Network error fetching config:", e);
    }
  }
}

function populateAllSelects(data) {
  if (!data) return;
  document.querySelectorAll('.sel-shift').forEach(el => fill(el, data.shifts));
  document.querySelectorAll('.sel-operator').forEach(el => fill(el, data.operators));
  document.querySelectorAll('.sel-product').forEach(el => fill(el, data.products));
  document.querySelectorAll('.sel-station').forEach(el => fill(el, data.stations));
}

function fill(el, list) { 
  const currentVal = el.value;
  el.innerHTML = '<option>Ø§Ù†ØªØ®Ø§Ø¨...</option>'; 
  if(list && list.length > 0) {
    list.forEach(i => el.innerHTML += `<option value="${i}">${i}</option>`);
  } else {
    el.innerHTML = '<option>Ø®Ø§Ù„ÛŒ</option>';
  }
  if (currentVal && list.includes(currentVal)) el.value = currentVal;
}
</script>
</body>
</html>